name: "build_zditor"

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "version"
        required: true
jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest" # for Arm based macs (M1 and above).
            args: "--target aarch64-apple-darwin"
          - platform: "macos-latest" # for Intel based macs.
            args: "--target x86_64-apple-darwin"
          - platform: "ubuntu-22.04" # for Tauri v1 you could replace this with ubuntu-20.04.
            args: ""
          - platform: "windows-latest"
            args: ""
    runs-on: ${{ matrix.platform }}
    steps:
      # 使用 GitHub token 访问私有仓库
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.REPO }} # 替换为私有仓库的实际路径
          token: ${{ secrets.DEPLOY_TOKEN }} # 使用 GitHub 提供的 GITHUB_TOKEN 进行身份验证

      # 导入 Apple 证书（仅限 macOS）
      - name: Import Certificate
        if: matrix.platform == 'macos-latest'
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      # 解锁 Keychain（仅限 macOS）
      - name: Unlock keychain
        if: matrix.platform == 'macos-latest'
        run: |
          security set-keychain-password -p ${{ secrets.APPLE_KEYCHAIN_PASSWORD }} login.keychain || true
          security default-keychain -s login.keychain
          security unlock-keychain -p ${{ secrets.APPLE_KEYCHAIN_PASSWORD }} login.keychain

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: install frontend dependencies
        run: npm install # change this to npm, pnpm or bun depending on which one you use.

      - name: build frontend
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: npm run build

      # 跳过 ubuntu 平台的 AppImage 构建
      - name: Skip AppImage build for Ubuntu
        if: matrix.platform == 'ubuntu-22.04'
        run: echo "Skipping AppImage build on Ubuntu."

      - name: Get latest release notes from CHANGELOG.md
        id: get_release_notes
        shell: bash
        run: |
          TAG_NAME="${{ github.event.inputs.tag }}"
          echo "Current version: $TAG_NAME"

          if [ -f "CHANGELOG.md" ]; then
            echo "CHANGELOG.md exists, parsing release notes..."
            # Extract content between the current version header and next version header
            RELEASE_BODY=$(awk -v version="$TAG_NAME" '
              BEGIN { in_version = 0; first_line = 1 }
              /^## / && $2 == version { in_version = 1; next }
              /^## / && in_version { in_version = 0 }
              in_version {
                if (first_line) {
                  # Skip initial empty lines
                  if (NF) {
                    first_line = 0
                    print
                  }
                } else {
                  print
                }
              }
            ' CHANGELOG.md)

            echo "Raw release notes from CHANGELOG.md:"
            echo "------------------------------------"
            echo "$RELEASE_BODY"
            echo "------------------------------------"

            # Trim leading/trailing whitespace and empty lines (cross-platform method)
            RELEASE_BODY_TRIMMED=$(echo "$RELEASE_BODY" | sed -e ':a' -e '/./,$!d;/^\n*$/{$d;N;ba' -e '}' -e 's/[[:space:]]*$//')

            if [ -z "$RELEASE_BODY_TRIMMED" ]; then
              RELEASE_BODY_TRIMMED="See the assets to download this version and install."
              echo "No release notes found for this tag, using default message"
            fi
          else
            RELEASE_BODY_TRIMMED="See the assets to download this version and install."
            echo "CHANGELOG.md not found, using default message"
          fi

          echo "Final release notes that will be used:"
          echo "------------------------------------"
          echo "$RELEASE_BODY_TRIMMED"
          echo "------------------------------------"

          # Use multiline output format to preserve newlines
          {
            echo 'release_body<<EOF'
            echo "$RELEASE_BODY_TRIMMED"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

  
      # ====== 2. 构建、签名、公证 ======
      - name: Write Apple API Key
        if: matrix.platform == 'macos-latest'
        run: |
          echo "${{ secrets.APPLE_API_KEY_P8 }}" > ./apple-api-key.p8

      - uses: tauri-apps/tauri-action@v0
        if: matrix.platform == 'macos-latest'
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          NODE_OPTIONS: "--max-old-space-size=4096"
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # 以下是新增 Apple 签名 / 公证所需
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{secrets.APPLE_TEAM_ID}}

        with:
          tagName: zditor-v${{ github.event.inputs.tag }}
          releaseName: "Zditor v${{ github.event.inputs.tag }}"
          releaseBody: ${{ steps.get_release_notes.outputs.release_body }}
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

      # ====== 3. 非 macOS 平台开启 debug ======
      - uses: tauri-apps/tauri-action@v0
        if: matrix.platform != 'macos-latest'
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          NODE_OPTIONS: "--max-old-space-size=4096"
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: zditor-v${{ github.event.inputs.tag }}
          releaseName: "Zditor v${{ github.event.inputs.tag }}"
          releaseBody: ${{ steps.get_release_notes.outputs.release_body }}
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
